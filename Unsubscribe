Sub ExportUnsubscribeSenders()
    ' Declare Outlook and Excel objects
    Dim olApp As Outlook.Application
    Dim olNs As Outlook.NameSpace
    Dim olFolder As Outlook.MAPIFolder
    Dim olItem As Object
    Dim i As Long
    Dim startIndex As Long
    Dim countMatches As Long
    Dim wb As Object
    Dim ws As Object
    Dim nextRow As Long
    Dim bodySnippet As String
    
    ' Initialize Outlook
    Set olApp = Application
    Set olNs = olApp.GetNamespace("MAPI")
    Set olFolder = olNs.GetDefaultFolder(olFolderInbox)
    
    ' Determine starting index for the most recent 500 emails
    If olFolder.items.Count > 500 Then
        startIndex = olFolder.items.Count - 499
    Else
        startIndex = 1
    End If
    
    ' Create new Excel workbook
    Set wb = CreateObject("Excel.Application")
    wb.Visible = True
    Set ws = wb.Workbooks.Add.Worksheets(1)
    ws.Cells(1, 1).Value = "Sender Email"
    ws.Cells(1, 2).Value = "Subject"
    ws.Cells(1, 3).Value = "Date Received"
    nextRow = 2
    
    ' Loop through the most recent 500 items
    countMatches = 0
    For i = olFolder.items.Count To startIndex Step -1
        Set olItem = olFolder.items(i)
        ' Ensure it's a MailItem
        If TypeName(olItem) = "MailItem" Then
            bodySnippet = Left$(olItem.Body, 400)
            If InStr(1, bodySnippet, "unsubscribe", vbTextCompare) > 0 _
               Or InStr(1, olItem.Subject, "unsubscribe", vbTextCompare) > 0 Then
                ' Write to Excel
                ws.Cells(nextRow, 1).Value = olItem.SenderEmailAddress
                ws.Cells(nextRow, 2).Value = olItem.Subject
                ws.Cells(nextRow, 3).Value = olItem.ReceivedTime
                nextRow = nextRow + 1
                countMatches = countMatches + 1
            End If
        End If
    Next i
    
    ' Autofit columns
    ws.Columns("A:C").AutoFit
    
    MsgBox countMatches & " emails found containing 'unsubscribe' and exported to Excel.", vbInformation, "Export Complete"

    ' Clean up
    Set ws = Nothing
    Set wb = Nothing
    Set olItem = Nothing
    Set olFolder = Nothing
    Set olNs = Nothing
    Set olApp = Nothing
End Sub

